<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QRMEDBR — Viewer</title>

  <style>
    :root{
      --bg:#ffffff; --fg:#111111; --muted:rgba(0,0,0,.72);
      --card:#ffffff; --border:#dddddd; --subtle:#f6f6f6;
      --danger:#b00020; --accent:#111111; --pill-bg:transparent;
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0f1115; --fg:#f1f3f5; --muted:rgba(241,243,245,.72);
        --card:#151924; --border:#2a3142; --subtle:#1b2233;
        --danger:#ff6b81; --accent:#f1f3f5; --pill-bg:rgba(241,243,245,.06);
      }
    }

    body{font-family:Arial,sans-serif;margin:16px;background:var(--bg);color:var(--fg)}
    .wrap{max-width:980px;margin:0 auto}
    .card{border:1px solid var(--border);border-radius:14px;padding:14px;margin:12px 0;background:var(--card)}
    h1{font-size:18px;margin:0 0 10px}
    h2{font-size:14px;margin:14px 0 6px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .lbl{font-size:12px;opacity:.75}
    .val{font-size:14px;font-weight:800}
    .emg{border:2px solid var(--accent)}
    ul{margin:6px 0 0 18px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border:1px solid var(--border);padding:6px;vertical-align:top}
    th{background:var(--subtle);text-align:left}
    .err{color:var(--danger);font-weight:800}
    code{word-break:break-word;background:var(--subtle);padding:2px 4px;border-radius:6px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{
      padding:10px 12px;border:1px solid var(--border);border-radius:10px;
      background:var(--card);color:var(--fg);cursor:pointer;
    }
    button:active{transform:scale(.99)}
    a.tel{font-weight:800;text-decoration:none;color:var(--fg)}
    .muted{font-size:12px;color:var(--muted)}

    /* =========================
       Destaques no 1º quadro
       - Forte: Tipo sanguíneo, Alergias, Condições
       - Neutro: Altura, Peso
       ========================= */
    .topline{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top:12px; align-items:stretch;
    }
    .hi{
      border:2px solid var(--accent);
      border-radius:14px;
      padding:12px 12px;
      background: linear-gradient(180deg, var(--subtle), transparent);
      min-width: 220px;
      flex: 1 1 260px;
    }
    .hi .k{
      font-size:12px; opacity:.8; letter-spacing:.2px;
      text-transform:uppercase; font-weight:800; margin-bottom:6px;
    }
    .hi .v{
      font-size:18px; font-weight:900; line-height:1.2;
      word-break:break-word;
    }

    .metrics{
      display:flex; flex-wrap:wrap; gap:8px;
      align-items:center; justify-content:flex-start;
      padding:10px 0 0;
      flex: 1 1 260px;
      min-width: 220px;
    }
    .chip{
      display:inline-flex;
      align-items:baseline;
      gap:6px;
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 10px;
      background: var(--pill-bg);
      font-size:13px;
      white-space:nowrap;
    }
    .chip b{font-weight:800}
    .chip .u{opacity:.75; font-size:12px; font-weight:700}

    @media print{
      button,.muted{display:none !important}
      body{margin:0}
      .card{page-break-inside:avoid}
      .hi,.chip{break-inside:avoid}
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="actions">
    <button onclick="window.print()">Imprimir</button>
  </div>

  <div class="muted">
    QRMEDBR Viewer: os dados são lidos do <code>#</code> da URL e processados localmente no navegador.
  </div>

  <div id="out"></div>

  <div class="card">
    <h1>Aviso legal e consentimento</h1>
    <div class="muted">
      Este QR Code foi criado voluntariamente pelo titular para <b>facilitar atendimento em emergência</b>.
      As informações podem estar desatualizadas e <b>não substituem avaliação médica</b>.
      Ao acessar este QR, você concorda em usar os dados <b>somente para cuidado/triagem</b> e evitar compartilhamento indevido.
      (Boas práticas de privacidade/LGPD: minimização, finalidade, necessidade e segurança.)
    </div>
  </div>

</div>

<script>
const LZString = (function() {
  const f = String.fromCharCode;
  const keyStrUriSafe = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$";
  const getBaseValue = (alphabet, character) => alphabet.indexOf(character);

  function decompressFromEncodedURIComponent(input) {
    if (input == null) return "";
    if (input === "") return null;
    return _decompress(input.length, 32, index => getBaseValue(keyStrUriSafe, input.charAt(index)));
  }

  function _decompress(length, resetValue, getNextValue) {
    const dictionary = [];
    let next;
    let enlargeIn = 4;
    let dictSize = 4;
    let numBits = 3;
    let entry = "";
    const result = [];
    let i;
    let w;
    let bits, resb, maxpower, power;
    let c;
    const data = { val: getNextValue(0), position: resetValue, index: 1 };

    for (i = 0; i < 3; i++) dictionary[i] = i;

    bits = 0; maxpower = Math.pow(2, 2); power = 1;
    while (power !== maxpower) {
      resb = data.val & data.position;
      data.position >>= 1;
      if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
      bits |= (resb > 0 ? 1 : 0) * power;
      power <<= 1;
    }

    switch (next = bits) {
      case 0:
        bits = 0; maxpower = Math.pow(2, 8); power = 1;
        while (power !== maxpower) {
          resb = data.val & data.position;
          data.position >>= 1;
          if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
          bits |= (resb > 0 ? 1 : 0) * power;
          power <<= 1;
        }
        c = f(bits);
        break;
      case 1:
        bits = 0; maxpower = Math.pow(2, 16); power = 1;
        while (power !== maxpower) {
          resb = data.val & data.position;
          data.position >>= 1;
          if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
          bits |= (resb > 0 ? 1 : 0) * power;
          power <<= 1;
        }
        c = f(bits);
        break;
      case 2:
        return "";
    }
    dictionary[3] = c;
    w = c;
    result.push(c);

    while (true) {
      if (data.index > length) return "";

      bits = 0; maxpower = Math.pow(2, numBits); power = 1;
      while (power !== maxpower) {
        resb = data.val & data.position;
        data.position >>= 1;
        if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
        bits |= (resb > 0 ? 1 : 0) * power;
        power <<= 1;
      }

      switch (c = bits) {
        case 0:
          bits = 0; maxpower = Math.pow(2, 8); power = 1;
          while (power !== maxpower) {
            resb = data.val & data.position;
            data.position >>= 1;
            if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
            bits |= (resb > 0 ? 1 : 0) * power;
            power <<= 1;
          }
          dictionary[dictSize++] = f(bits);
          c = dictSize - 1;
          enlargeIn--;
          break;
        case 1:
          bits = 0; maxpower = Math.pow(2, 16); power = 1;
          while (power !== maxpower) {
            resb = data.val & data.position;
            data.position >>= 1;
            if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
            bits |= (resb > 0 ? 1 : 0) * power;
            power <<= 1;
          }
          dictionary[dictSize++] = f(bits);
          c = dictSize - 1;
          enlargeIn--;
          break;
        case 2:
          return result.join("");
      }

      if (enlargeIn === 0) { enlargeIn = Math.pow(2, numBits); numBits++; }

      if (dictionary[c]) entry = dictionary[c];
      else {
        if (c === dictSize) entry = w + w.charAt(0);
        else return null;
      }
      result.push(entry);

      dictionary[dictSize++] = w + entry.charAt(0);
      enlargeIn--;
      w = entry;

      if (enlargeIn === 0) { enlargeIn = Math.pow(2, numBits); numBits++; }
    }
  }

  return { decompressFromEncodedURIComponent };
})();

function esc(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function render(data){
  const out = document.getElementById("out");

  const pt = data.pt || {};
  const med = data.med || {};
  const ice = Array.isArray(data.ice) ? data.ice : [];

  const sexPretty = (pt.sex === "NA") ? "N/A" : (pt.sex || "—");

  const algInline = (Array.isArray(med.alg) && med.alg.length) ? med.alg.join(", ") : "";
  const condInline = (Array.isArray(med.cond) && med.cond.length) ? med.cond.join(", ") : "";

  // ✅ ÊNFASE: Tipo sanguíneo + Alergias + Condições
  const highlightBlocks = `
    <div class="topline">
      <div class="hi">
        <div class="k">Tipo sanguíneo</div>
        <div class="v">${esc(med.bt || "—")}</div>
      </div>
      ${algInline ? `
        <div class="hi">
          <div class="k">Alergias</div>
          <div class="v">${esc(algInline)}</div>
        </div>` : ``}
      ${condInline ? `
        <div class="hi">
          <div class="k">Condições</div>
          <div class="v">${esc(condInline)}</div>
        </div>` : ``}
    </div>
  `;

  // ✅ SEM ÊNFASE: Altura + Peso (chips neutros)
  const metrics = `
    <div class="metrics">
      <span class="chip"><b>Altura:</b> ${esc(med.ht ?? "—")} <span class="u">cm</span></span>
      <span class="chip"><b>Peso:</b> ${esc(med.wt ?? "—")} <span class="u">kg</span></span>
    </div>
  `;

  const iceHtml = ice.length
    ? `<ul>${ice.map((c,i)=>`
        <li>
          <b>${esc(c.n || ("ICE " + (i+1)))}</b>${c.p ? ` — ${esc(c.p)}` : ""}<br/>
          ${c.t ? `<a class="tel" href="tel:${esc(c.t)}">${esc(c.t)}</a>` : `<span class="muted">Telefone não informado</span>`}
        </li>`).join("")}</ul>`
    : `<p class="muted"><em>Nenhum contato informado</em></p>`;

  const algHtml = (med.alg && med.alg.length)
    ? `<ul>${med.alg.map(x=>`<li>${esc(x)}</li>`).join("")}</ul>`
    : `<p class="muted"><em>Não informado</em></p>`;

  const condHtml = (med.cond && med.cond.length)
    ? `<ul>${med.cond.map(x=>`<li>${esc(x)}</li>`).join("")}</ul>`
    : `<p class="muted"><em>Não informado</em></p>`;

  const rxHtml = (Array.isArray(med.rx) && med.rx.length)
    ? `<table>
        <thead><tr><th>Medicamento</th><th>Dose</th><th>Frequência</th><th>Via</th></tr></thead>
        <tbody>
          ${med.rx.map(m=>`
            <tr>
              <td>${esc(m.n||"")}</td>
              <td>${esc(m.d||"")}</td>
              <td>${esc(m.f||"")}</td>
              <td>${esc(m.r||"")}</td>
            </tr>`).join("")}
        </tbody>
      </table>`
    : `<p class="muted"><em>Não informado</em></p>`;

  out.innerHTML = `
    <div class="card emg">
      <h1>Resumo de Emergência — QRMEDBR</h1>
      <div class="grid">
        <div><div class="lbl">Nome</div><div class="val">${esc(pt.n) || "—"}</div></div>
        <div><div class="lbl">Nascimento</div><div class="val">${esc(pt.dob) || "—"}</div></div>
        <div><div class="lbl">Sexo</div><div class="val">${esc(sexPretty)}</div></div>
        <div><div class="lbl">Endereço</div><div class="val">${esc(pt.addr) || "—"}</div></div>
      </div>

      ${highlightBlocks}
      ${metrics}

      ${med.note ? `<div style="margin-top:12px"><b>Obs:</b> ${esc(med.note)}</div>` : ""}
    </div>

    <div class="card">
      <h1>Contatos de Emergência (ICE)</h1>
      ${iceHtml}
    </div>

    <div class="card">
      <h1>Detalhes Médicos</h1>
      <h2>Alergias</h2>${algHtml}
      <h2>Condições prévias</h2>${condHtml}
      <h2>Medicamentos em uso</h2>${rxHtml}
    </div>
  `;
}

function decodePayload(hash){
  const h = (hash||"").replace(/^#/, "").trim();
  if (!h) throw new Error("Hash vazio (nenhum dado no QR).");

  if (h.startsWith("lz:")) {
    const payload = h.slice(3);
    const json = LZString.decompressFromEncodedURIComponent(payload);
    if (!json) throw new Error("Falha ao descomprimir payload (lz).");
    return JSON.parse(json);
  }

  if (h.startsWith("{")) return JSON.parse(h);

  throw new Error("Formato de payload desconhecido.");
}

(function init(){
  const out = document.getElementById("out");
  try{
    const data = decodePayload(location.hash);
    render(data);
  } catch(e){
    out.innerHTML = `<div class="card"><div class="err">Erro ao carregar dados do QR:</div><code>${esc(String(e))}</code></div>`;
  }
})();
</script>
</body>
</html>
