<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EQR – Visualização</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; max-width: 820px; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    h2 { font-size: 14px; margin: 14px 0 6px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .lbl { font-size: 12px; opacity: .75; }
    .val { font-size: 14px; font-weight: 700; }
    ul { margin: 6px 0 0 18px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { border: 1px solid #ddd; padding: 6px; vertical-align: top; }
    th { background: #f6f6f6; text-align: left; }
    .err { color: #b00020; font-weight: 700; }
    code { word-break: break-word; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Dados Médicos (EQR)</h1>
    <div id="content">Carregando…</div>
  </div>

<script>
  function b64urlDecodeToString(b64url) {
    const b64 = b64url.replace(/-/g, "+").replace(/_/g, "/") + "===".slice((b64url.length + 3) % 4);
    const bin = atob(b64);
    // UTF-8 safe decode
    const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
    return new TextDecoder("utf-8").decode(bytes);
  }

  function esc(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function render(d) {
    const content = document.getElementById("content");
    const alergias = (d.a && d.a.length) ? `<ul>${d.a.map(x => `<li>${esc(x)}</li>`).join("")}</ul>` : `<em>Não informado</em>`;
    const cond = (d.c && d.c.length) ? `<ul>${d.c.map(x => `<li>${esc(x)}</li>`).join("")}</ul>` : `<em>Não informado</em>`;
    const meds = (d.m && d.m.length)
      ? `<table><thead><tr><th>Medicamento</th><th>Dosagem</th><th>Frequência</th></tr></thead><tbody>
          ${d.m.map(m => `<tr><td>${esc(m.n)}</td><td>${esc(m.d)}</td><td>${esc(m.f)}</td></tr>`).join("")}
         </tbody></table>`
      : `<em>Não informado</em>`;

    content.innerHTML = `
      <div class="grid">
        <div><div class="lbl">Nome</div><div class="val">${esc(d.n) || "—"}</div></div>
        <div><div class="lbl">Nascimento</div><div class="val">${esc(d.d) || "—"}</div></div>
        <div><div class="lbl">Tipo sanguíneo</div><div class="val">${esc(d.ts) || "—"}</div></div>
      </div>

      <h2>Alergias</h2>${alergias}
      <h2>Condições prévias</h2>${cond}
      <h2>Medicamentos em uso</h2>${meds}

      <h2>Dados brutos</h2>
      <code>${esc(JSON.stringify(d))}</code>
    `;
  }

  (function init() {
    const hash = (location.hash || "").slice(1).trim();
    const content = document.getElementById("content");

    if (!hash) {
      content.innerHTML = `<div class="err">Nenhum dado encontrado no QR (hash vazio).</div>`;
      return;
    }

    try {
      const json = b64urlDecodeToString(hash);
      const data = JSON.parse(json);
      render(data);
    } catch (e) {
      content.innerHTML = `<div class="err">Falha ao decodificar os dados.</div><code>${esc(String(e))}</code>`;
    }
  })();
</script>
</body>
</html>
